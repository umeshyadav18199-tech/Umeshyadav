<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Photo & Location (Consent required)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; max-width: 760px; margin: auto; }
    h1 { font-size: 22px; margin-bottom: 6px; }
    video, canvas { width: 100%; max-height: 420px; background: #000; border-radius: 8px; }
    button { padding: 10px 14px; margin: 8px 6px 8px 0; font-size: 15px; border-radius: 8px; cursor: pointer; }
    #status { margin-top: 8px; color: #333; }
    .danger { color: #a00; font-weight: bold; }
    .result-box { margin-top: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background:#fafafa;}
    a.small { font-size:13px; color:#0366d6; text-decoration:none; }
  </style>
</head>
<body>
  <h1>Photo + Location (Consent)</h1>
  <p>Is page se user jab <strong>Start</strong> karega, browser camera aur location permission maangega. <strong>Sirf</strong> jab user allow karega tabhi photo aur location milega.</p>

  <button id="startBtn">Start (Request Camera & Location)</button>
  <button id="snapBtn" disabled>Take Photo</button>
  <button id="stopBtn" disabled>Stop Camera</button>

  <div id="status">Status: ready</div>

  <div style="margin-top:10px;">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
  </div>

  <div id="result" class="result-box"></div>

<script>
const startBtn = document.getElementById('startBtn');
const snapBtn  = document.getElementById('snapBtn');
const stopBtn  = document.getElementById('stopBtn');
const status   = document.getElementById('status');
const video    = document.getElementById('video');
const canvas   = document.getElementById('canvas');
const result   = document.getElementById('result');
let stream = null;

function setStatus(s){ status.textContent = 'Status: ' + s; }

startBtn.addEventListener('click', async () => {
  setStatus('Requesting camera...');
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
    video.srcObject = stream;
    snapBtn.disabled = false;
    stopBtn.disabled = false;
    setStatus('Camera access granted. Ab photo lene ke liye "Take Photo" dabayein.');
  } catch (err) {
    console.error(err);
    setStatus('Camera access denied ya available nahi: ' + err.message);
  }

  if ("geolocation" in navigator) {
    setStatus('Requesting location...');
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        result.innerHTML = `<strong>Location:</strong> ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (accuracy ${accuracy} m)`;
        setStatus('Location received.');
      },
      err => {
        console.warn(err);
        result.innerHTML = `<div class="danger">Location access denied: ${err.message}</div>`;
        setStatus('Location denied or unavailable.');
      },
      { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
    );
  } else {
    result.innerHTML = '<div class="danger">Geolocation not supported by this browser.</div>';
    setStatus('Geolocation not supported.');
  }
});

snapBtn.addEventListener('click', () => {
  if (!stream) return;
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
  const html = `
    <div>
      <strong>Captured photo:</strong><br>
      <img src="${dataUrl}" alt="photo" style="max-width:100%;height:auto;border:1px solid #ccc;margin-top:6px;border-radius:6px;"><br>
      <a class="small" href="${dataUrl}" download="photo.jpg">Download photo</a>
    </div>`;
  result.innerHTML += html;
  setStatus('Photo captured (user consented).');
});

stopBtn.addEventListener('click', () => {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    video.srcObject = null;
    snapBtn.disabled = true;
    stopBtn.disabled = true;
    setStatus('Camera stopped.');
  }
});

window.addEventListener('beforeunload', () => {
  if (stream) stream.getTracks().forEach(t => t.stop());
});
</script>
</body>
</html>
